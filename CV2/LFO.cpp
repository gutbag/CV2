#include "LFO.h"
#include "MIDI.h"

#define ARRAYSIZE(x) (sizeof(x)/sizeof(x[0]))

#define SAMPLES_360

#ifdef SAMPLES_360
static uint8_t sinSamples[] = {
	0,
	0,
	0,
	0,
	0,
	1,
	1,
	1,
	2,
	2,
	2,
	3,
	3,
	4,
	4,
	5,
	6,
	6,
	7,
	8,
	8,
	9,
	10,
	11,
	12,
	13,
	14,
	15,
	16,
	17,
	18,
	19,
	20,
	22,
	23,
	24,
	26,
	27,
	28,
	30,
	31,
	33,
	34,
	36,
	37,
	39,
	40,
	42,
	44,
	45,
	47,
	49,
	51,
	52,
	54,
	56,
	58,
	60,
	62,
	63,
	65,
	67,
	69,
	71,
	73,
	75,
	77,
	79,
	81,
	84,
	86,
	88,
	90,
	92,
	94,
	96,
	98,
	101,
	103,
	105,
	107,
	109,
	112,
	114,
	116,
	118,
	120,
	123,
	125,
	127,
	127,
	129,
	131,
	134,
	136,
	138,
	140,
	142,
	145,
	147,
	149,
	151,
	153,
	156,
	158,
	160,
	162,
	164,
	166,
	168,
	170,
	173,
	175,
	177,
	179,
	181,
	183,
	185,
	187,
	189,
	191,
	192,
	194,
	196,
	198,
	200,
	202,
	203,
	205,
	207,
	209,
	210,
	212,
	214,
	215,
	217,
	218,
	220,
	221,
	223,
	224,
	226,
	227,
	228,
	230,
	231,
	232,
	234,
	235,
	236,
	237,
	238,
	239,
	240,
	241,
	242,
	243,
	244,
	245,
	246,
	246,
	247,
	248,
	248,
	249,
	250,
	250,
	251,
	251,
	252,
	252,
	252,
	253,
	253,
	253,
	254,
	254,
	254,
	254,
	254,
	254,
	254,
	254,
	254,
	254,
	254,
	253,
	253,
	253,
	252,
	252,
	252,
	251,
	251,
	250,
	250,
	249,
	248,
	248,
	247,
	246,
	246,
	245,
	244,
	243,
	242,
	241,
	240,
	239,
	238,
	237,
	236,
	235,
	234,
	232,
	231,
	230,
	228,
	227,
	226,
	224,
	223,
	221,
	220,
	218,
	217,
	215,
	214,
	212,
	210,
	209,
	207,
	205,
	203,
	202,
	200,
	198,
	196,
	194,
	192,
	191,
	189,
	187,
	185,
	183,
	181,
	179,
	177,
	175,
	173,
	170,
	168,
	166,
	164,
	162,
	160,
	158,
	156,
	153,
	151,
	149,
	147,
	145,
	142,
	140,
	138,
	136,
	134,
	131,
	129,
	127,
	125,
	123,
	120,
	118,
	116,
	114,
	112,
	109,
	107,
	105,
	103,
	101,
	98,
	96,
	94,
	92,
	90,
	88,
	86,
	84,
	81,
	79,
	77,
	75,
	73,
	71,
	69,
	67,
	65,
	63,
	62,
	60,
	58,
	56,
	54,
	52,
	51,
	49,
	47,
	45,
	44,
	42,
	40,
	39,
	37,
	36,
	34,
	33,
	31,
	30,
	28,
	27,
	26,
	24,
	23,
	22,
	20,
	19,
	18,
	17,
	16,
	15,
	14,
	13,
	12,
	11,
	10,
	9,
	8,
	8,
	7,
	6,
	6,
	5,
	4,
	4,
	3,
	3,
	2,
	2,
	2,
	1,
	1,
	1,
	0,
	0,
	0,
	0,
	0
};
static const uint16_t phaseOffsets[] =
{
	0, // CC value 0
	45, // 1
	90, // 2
	135,// 3
	180,// 4
	225,// 5
	270,// 6
	315 // 7
};

#else

// 1080 samples (360 * 3) - no steps > 1

static uint8_t sinSamples[] = {
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	1,
	1,
	1,
	1,
	1,
	1,
	1,
	1,
	1,
	1,
	1,
	2,
	2,
	2,
	2,
	2,
	2,
	2,
	2,
	3,
	3,
	3,
	3,
	3,
	3,
	4,
	4,
	4,
	4,
	4,
	5,
	5,
	5,
	5,
	5,
	6,
	6,
	6,
	6,
	6,
	7,
	7,
	7,
	7,
	8,
	8,
	8,
	8,
	9,
	9,
	9,
	10,
	10,
	10,
	10,
	11,
	11,
	11,
	12,
	12,
	12,
	13,
	13,
	13,
	14,
	14,
	14,
	15,
	15,
	15,
	16,
	16,
	16,
	17,
	17,
	17,
	18,
	18,
	19,
	19,
	19,
	20,
	20,
	21,
	21,
	21,
	22,
	22,
	23,
	23,
	23,
	24,
	24,
	25,
	25,
	26,
	26,
	27,
	27,
	27,
	28,
	28,
	29,
	29,
	30,
	30,
	31,
	31,
	32,
	32,
	33,
	33,
	34,
	34,
	35,
	35,
	36,
	36,
	37,
	37,
	38,
	38,
	39,
	39,
	40,
	41,
	41,
	42,
	42,
	43,
	43,
	44,
	44,
	45,
	46,
	46,
	47,
	47,
	48,
	48,
	49,
	50,
	50,
	51,
	51,
	52,
	53,
	53,
	54,
	54,
	55,
	56,
	56,
	57,
	57,
	58,
	59,
	59,
	60,
	61,
	61,
	62,
	62,
	63,
	64,
	64,
	65,
	66,
	66,
	67,
	68,
	68,
	69,
	70,
	70,
	71,
	72,
	72,
	73,
	74,
	74,
	75,
	76,
	76,
	77,
	78,
	78,
	79,
	80,
	80,
	81,
	82,
	82,
	83,
	84,
	85,
	85,
	86,
	87,
	87,
	88,
	89,
	90,
	90,
	91,
	92,
	92,
	93,
	94,
	94,
	95,
	96,
	97,
	97,
	98,
	99,
	100,
	100,
	101,
	102,
	102,
	103,
	104,
	105,
	105,
	106,
	107,
	108,
	108,
	109,
	110,
	110,
	111,
	112,
	113,
	113,
	114,
	115,
	116,
	116,
	117,
	118,
	119,
	119,
	120,
	121,
	122,
	122,
	123,
	124,
	125,
	125,
	126,
	127,
	127,
	128,
	128,
	129,
	130,
	130,
	131,
	132,
	133,
	133,
	134,
	135,
	136,
	136,
	137,
	138,
	139,
	139,
	140,
	141,
	142,
	142,
	143,
	144,
	145,
	145,
	146,
	147,
	147,
	148,
	149,
	150,
	150,
	151,
	152,
	153,
	153,
	154,
	155,
	155,
	156,
	157,
	158,
	158,
	159,
	160,
	160,
	161,
	162,
	163,
	163,
	164,
	165,
	165,
	166,
	167,
	168,
	168,
	169,
	170,
	170,
	171,
	172,
	172,
	173,
	174,
	175,
	175,
	176,
	177,
	177,
	178,
	179,
	179,
	180,
	181,
	181,
	182,
	183,
	183,
	184,
	185,
	185,
	186,
	187,
	187,
	188,
	189,
	189,
	190,
	191,
	191,
	192,
	193,
	193,
	194,
	194,
	195,
	196,
	196,
	197,
	198,
	198,
	199,
	199,
	200,
	201,
	201,
	202,
	202,
	203,
	204,
	204,
	205,
	205,
	206,
	207,
	207,
	208,
	208,
	209,
	209,
	210,
	211,
	211,
	212,
	212,
	213,
	213,
	214,
	214,
	215,
	216,
	216,
	217,
	217,
	218,
	218,
	219,
	219,
	220,
	220,
	221,
	221,
	222,
	222,
	223,
	223,
	224,
	224,
	225,
	225,
	226,
	226,
	227,
	227,
	228,
	228,
	228,
	229,
	229,
	230,
	230,
	231,
	231,
	232,
	232,
	232,
	233,
	233,
	234,
	234,
	234,
	235,
	235,
	236,
	236,
	236,
	237,
	237,
	238,
	238,
	238,
	239,
	239,
	239,
	240,
	240,
	240,
	241,
	241,
	241,
	242,
	242,
	242,
	243,
	243,
	243,
	244,
	244,
	244,
	245,
	245,
	245,
	245,
	246,
	246,
	246,
	247,
	247,
	247,
	247,
	248,
	248,
	248,
	248,
	249,
	249,
	249,
	249,
	249,
	250,
	250,
	250,
	250,
	250,
	251,
	251,
	251,
	251,
	251,
	252,
	252,
	252,
	252,
	252,
	252,
	253,
	253,
	253,
	253,
	253,
	253,
	253,
	253,
	254,
	254,
	254,
	254,
	254,
	254,
	254,
	254,
	254,
	254,
	254,
	255,
	255,
	255,
	255,
	255,
	255,
	255,
	255,
	255,
	255,
	255,
	255,
	255,
	255,
	255,
	255,
	255,
	255,
	255,
	255,
	255,
	255,
	255,
	255,
	255,
	255,
	255,
	255,
	255,
	255,
	255,
	254,
	254,
	254,
	254,
	254,
	254,
	254,
	254,
	254,
	254,
	254,
	253,
	253,
	253,
	253,
	253,
	253,
	253,
	253,
	252,
	252,
	252,
	252,
	252,
	252,
	251,
	251,
	251,
	251,
	251,
	250,
	250,
	250,
	250,
	250,
	249,
	249,
	249,
	249,
	249,
	248,
	248,
	248,
	248,
	247,
	247,
	247,
	247,
	246,
	246,
	246,
	245,
	245,
	245,
	245,
	244,
	244,
	244,
	243,
	243,
	243,
	242,
	242,
	242,
	241,
	241,
	241,
	240,
	240,
	240,
	239,
	239,
	239,
	238,
	238,
	238,
	237,
	237,
	236,
	236,
	236,
	235,
	235,
	234,
	234,
	234,
	233,
	233,
	232,
	232,
	232,
	231,
	231,
	230,
	230,
	229,
	229,
	228,
	228,
	228,
	227,
	227,
	226,
	226,
	225,
	225,
	224,
	224,
	223,
	223,
	222,
	222,
	221,
	221,
	220,
	220,
	219,
	219,
	218,
	218,
	217,
	217,
	216,
	216,
	215,
	214,
	214,
	213,
	213,
	212,
	212,
	211,
	211,
	210,
	209,
	209,
	208,
	208,
	207,
	207,
	206,
	205,
	205,
	204,
	204,
	203,
	202,
	202,
	201,
	201,
	200,
	199,
	199,
	198,
	198,
	197,
	196,
	196,
	195,
	194,
	194,
	193,
	193,
	192,
	191,
	191,
	190,
	189,
	189,
	188,
	187,
	187,
	186,
	185,
	185,
	184,
	183,
	183,
	182,
	181,
	181,
	180,
	179,
	179,
	178,
	177,
	177,
	176,
	175,
	175,
	174,
	173,
	173,
	172,
	171,
	170,
	170,
	169,
	168,
	168,
	167,
	166,
	165,
	165,
	164,
	163,
	163,
	162,
	161,
	161,
	160,
	159,
	158,
	158,
	157,
	156,
	155,
	155,
	154,
	153,
	153,
	152,
	151,
	150,
	150,
	149,
	148,
	147,
	147,
	146,
	145,
	145,
	144,
	143,
	142,
	142,
	141,
	140,
	139,
	139,
	138,
	137,
	136,
	136,
	135,
	134,
	133,
	133,
	132,
	131,
	130,
	130,
	129,
	128,
	128,
	127,
	126,
	125,
	125,
	124,
	123,
	122,
	122,
	121,
	120,
	119,
	119,
	118,
	117,
	116,
	116,
	115,
	114,
	113,
	113,
	112,
	111,
	110,
	110,
	109,
	108,
	108,
	107,
	106,
	105,
	105,
	104,
	103,
	102,
	102,
	101,
	100,
	100,
	99,
	98,
	97,
	97,
	96,
	95,
	95,
	94,
	93,
	92,
	92,
	91,
	90,
	90,
	89,
	88,
	87,
	87,
	86,
	85,
	85,
	84,
	83,
	83,
	82,
	81,
	80,
	80,
	79,
	78,
	78,
	77,
	76,
	76,
	75,
	74,
	74,
	73,
	72,
	72,
	71,
	70,
	70,
	69,
	68,
	68,
	67,
	66,
	66,
	65,
	64,
	64,
	63,
	62,
	62,
	61,
	61,
	60,
	59,
	59,
	58,
	57,
	57,
	56,
	56,
	55,
	54,
	54,
	53,
	53,
	52,
	51,
	51,
	50,
	50,
	49,
	48,
	48,
	47,
	47,
	46,
	46,
	45,
	44,
	44,
	43,
	43,
	42,
	42,
	41,
	41,
	40,
	39,
	39,
	38,
	38,
	37,
	37,
	36,
	36,
	35,
	35,
	34,
	34,
	33,
	33,
	32,
	32,
	31,
	31,
	30,
	30,
	29,
	29,
	28,
	28,
	27,
	27,
	27,
	26,
	26,
	25,
	25,
	24,
	24,
	23,
	23,
	23,
	22,
	22,
	21,
	21,
	21,
	20,
	20,
	19,
	19,
	19,
	18,
	18,
	17,
	17,
	17,
	16,
	16,
	16,
	15,
	15,
	15,
	14,
	14,
	14,
	13,
	13,
	13,
	12,
	12,
	12,
	11,
	11,
	11,
	10,
	10,
	10,
	10,
	9,
	9,
	9,
	8,
	8,
	8,
	8,
	7,
	7,
	7,
	7,
	6,
	6,
	6,
	6,
	6,
	5,
	5,
	5,
	5,
	5,
	4,
	4,
	4,
	4,
	4,
	3,
	3,
	3,
	3,
	3,
	3,
	2,
	2,
	2,
	2,
	2,
	2,
	2,
	2,
	1,
	1,
	1,
	1,
	1,
	1,
	1,
	1,
	1,
	1,
	1,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0
};

// sample index offsets to give various phase offsets
static const uint16_t phaseOffsets[] =
{
	0, // CC value 0
	45 * 3, // 1
	90 * 3, // 2
	135 * 3, // 3
	180 * 3, // 4
	225 * 3, // 5
	270 * 3, // 6
	315 * 3 // 7
};

#endif

typedef struct
{
	float fMin;
	float fMax;
} RangeValues;

// ranges selected by CC value
static const RangeValues rangeValues[] =
{
	{0.01, 0.05},
	{0.05, 0.1},
	{0.1, 1.0},
	{1.0, 10.0},
	{0.1, 10.0}
};

static LFO* pInstances[2] = {NULL, NULL};

LFO& LFO::instance(const uint8_t index)
{
	return *pInstances[index];
}

LFO::LFO(const uint8_t index, const uint8_t aMidiChannel)
: OnOffTriggerable(aMidiChannel, LFO_TRIGGER_INSTANCE_CC),
  sampleIndex(0), usLastSample(0), usBetweenSamples(0),
  freqStep(aMidiChannel, LFO_FREQUENCY_MIN_CC, LFO_FREQUENCY_MAX_CC, LFO_FREQUENCY_SOURCE_CC),
  freqRange(0), freqStepValue(0),
  midiChannel(aMidiChannel),
  slave(NULL),
  phaseOffsetIndex(0)
{
	pInstances[index] = this;
	setDefaults(true, true);
}

LFO::~LFO()
{
}

uint16_t LFO::getMinimum()
{
	return 0;
}

uint16_t LFO::getMaximum()
{
	return 255;
}

uint16_t LFO::getValue()
{
	return sinSamples[sampleIndex];
}

void LFO::setup()
{
	OnOffTriggerable::setup();
	freqStep.setup();
	MIDI::instance().setCCListener(this, midiChannel, LFO_FREQUENCY_RANGE_CC);
	MIDI::instance().setCCListener(this, midiChannel, LFO_PHASE_OFFSET_CC);
	
	freqStep.setMinimum(0);
	freqStep.setMaximum(127);

	setFrequencyRange(freqRange);
	setFrequency(true);
}

void LFO::loop(const unsigned long usNow)
{
	if (phaseOffsetIndex == 0) // otherwise, we're a slave
	{
		if (usNow - usLastSample >= usBetweenSamples)
		{
			boolean triggered = isTriggered();
			
			if (triggered)
			{
				sampleIndex++;
				if (sampleIndex >= sizeof(sinSamples)) // TODO: sample width?
					sampleIndex = 0;
				
				usLastSample = usNow;
				
				setFrequency(false);
				
				if (slave != NULL)
					slave->setSampleIndex(sampleIndex);
			}
		}
	}
}

void LFO::setSampleIndex(const uint16_t i)
{
	if (isTriggered() && phaseOffsetIndex > 0) // we're a slave
	{
		sampleIndex = i + phaseOffsets[phaseOffsetIndex];
		if (sampleIndex >=ARRAYSIZE(sinSamples))
			sampleIndex -= ARRAYSIZE(sinSamples);
	}
}

void LFO::setFrequency(const boolean force)
{
	uint16_t freqStepNewValue = freqStep.getValue();
	
	if (force || (freqStepNewValue != freqStepValue)) // re-calc delay between samples
	{
		freqStepValue = freqStepNewValue;
	
		float f;
		
		if (freqStepValue == 0)
			f = fMin;
		else
			f = fMin + hertzPerStep * (float)freqStepValue;
		
		float period = 1.0 / f;
		usBetweenSamples = (unsigned long)(1.0E6 * period / (float)(sizeof(sinSamples)) + 0.5);
	}
	
	//	Serial.print("LFO setFrequency: freqStep: ");
	//	Serial.print(freqStep);
	//	Serial.print(" hertzPerStep: ");
	//	Serial.print(hertzPerStep, 4);
	//	Serial.print(" (float)freqStep: ");
	//	Serial.print((float)freqStep, 4);
	//	Serial.print(" f: ");
	//	Serial.print(f, 4);
	//	Serial.print(" usBetweenSamples: ");
	//	Serial.println(usBetweenSamples, DEC);
	
	//	usBetweenSamples = 27700;
}

void LFO::setFrequencyRange(const uint8_t value)
{
	freqRange = value;
	
	uint8_t numRanges = sizeof(rangeValues) / sizeof(RangeValues);
	
	if (freqRange >= numRanges) // limit
		freqRange = numRanges - 1;
	
	fMin = rangeValues[freqRange].fMin;
	fMax = rangeValues[freqRange].fMax;
	
	hertzPerStep = (fMax - fMin) / 128.0;
}

void LFO::addSlave(LFO* pLFO)
{
	slave = pLFO;
}

void LFO::processCCMessage(const uint8_t channel,
							   const uint8_t controllerNumber,
							   const uint8_t value)
{
	//	Serial.print("LFO Message, ch: ");
	//	Serial.print(channel, DEC);
	//	Serial.print(" No: ");
	//	Serial.print(controllerNumber, DEC);
	//	Serial.print(" Val: ");
	//	Serial.println(value, DEC);
	
	switch (controllerNumber)
	{
		case LFO_FREQUENCY_RANGE_CC:
			setFrequencyRange(value);
			setFrequency(true);
			break;
		case LFO_PHASE_OFFSET_CC:
			phaseOffsetIndex = value;
			if (phaseOffsetIndex > ARRAYSIZE(phaseOffsets) - 1)
				phaseOffsetIndex = ARRAYSIZE(phaseOffsets) - 1;
			break;
		default:
			OnOffTriggerable::processCCMessage(channel, controllerNumber, value);
			//freqStep.processCCMessage(channel, controllerNumber, value);
			break;
	}
}

uint8_t LFO::getControllerValue(const uint8_t channel, const uint8_t controllerNumber)
{
	switch (controllerNumber)
	{
		case LFO_FREQUENCY_RANGE_CC:
			return freqRange;
		case LFO_PHASE_OFFSET_CC:
			return phaseOffsetIndex;
		default:
			return OnOffTriggerable::getControllerValue(channel, controllerNumber);
	}
}
